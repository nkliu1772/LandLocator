<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRE åœ°è™Ÿåº§æ¨™æŸ¥è©¢ç³»çµ±</title>
    <meta name="version" content="2.1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            overflow: hidden;
        }

        /* é ‚éƒ¨æ¨™é¡Œåˆ— */
        .header {
            background: linear-gradient(135deg, #3CBBC6 0%, #2a9da6 100%);
            color: white;
            padding: 1rem 1.5rem;
            font-size: 1.5rem;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .help-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .help-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        /* ä¸»è¦å®¹å™¨ - å·¦å³åˆ†æ¬„ */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            overflow: hidden;
        }

        /* å·¦å´é‚Šæ¬„ */
        .sidebar {
            width: 450px;
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #ddd;
            transition: width 0.3s ease;
            position: relative;
        }

        .sidebar.collapsed {
            width: 50px;
        }

        .sidebar-toggle-btn {
            position: absolute;
            top: 10px;
            right: -15px;
            width: 30px;
            height: 30px;
            background: #3CBBC6;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .sidebar-toggle-btn:hover {
            background: #2a9da6;
            transform: scale(1.1);
        }

        .sidebar.collapsed .sidebar-content {
            display: none;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        /* å³å´åœ°åœ–å®¹å™¨ */
        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* åœ°åœ–æ§åˆ¶æŒ‰éˆ•å€ */
        .map-controls {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            gap: 0.5rem;
            background: white;
            padding: 0.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .map-control-btn {
            padding: 0.5rem 1rem;
            background: white;
            color: #3CBBC6;
            border: 1px solid #3CBBC6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .map-control-btn:hover {
            background: #3CBBC6;
            color: white;
        }

        /* æ¨™è¨˜æ¨£å¼é¸å–® */
        .marker-style-dropdown {
            position: relative;
            display: inline-block;
        }

        .marker-style-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 0.5rem;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 200px;
            z-index: 1001;
        }

        .marker-style-menu.show {
            display: block;
        }

        .marker-style-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .marker-style-option:last-child {
            border-bottom: none;
        }

        .marker-style-option:hover {
            background-color: #f8f9fa;
        }

        .marker-style-option.active {
            background-color: #e8f5f6;
            color: #3CBBC6;
            font-weight: 600;
        }

        .marker-style-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        /* æ–‡å­—å¤§å°æ§åˆ¶ */
        .text-size-control {
            position: absolute;
            bottom: 80px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            min-width: 200px;
        }

        .text-size-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .text-size-value {
            color: #3CBBC6;
            font-size: 1rem;
        }

        .text-size-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        .text-size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3CBBC6;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .text-size-slider::-webkit-slider-thumb:hover {
            background: #2a9da6;
            transform: scale(1.2);
        }

        .text-size-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3CBBC6;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }

        .text-size-slider::-moz-range-thumb:hover {
            background: #2a9da6;
            transform: scale(1.2);
        }

        .text-size-presets {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
        }

        .text-size-preset-btn {
            flex: 1;
            padding: 0.4rem;
            margin: 0 0.2rem;
            font-size: 0.75rem;
            background: white;
            color: #3CBBC6;
            border: 1px solid #3CBBC6;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .text-size-preset-btn:hover {
            background: #3CBBC6;
            color: white;
        }

        /* æŸ¥è©¢è¡¨å–®å€å¡Š */
        .query-section {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #333;
        }

        .form-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
            font-weight: 500;
            display: block;
        }

        .land-input {
            width: 100%;
            min-height: 120px;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .land-input:focus {
            outline: none;
            border-color: #3CBBC6;
            box-shadow: 0 0 0 3px rgba(60, 187, 198, 0.1);
        }

        .button-group {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .query-button {
            flex: 1;
            padding: 0.75rem;
            background: linear-gradient(135deg, #3CBBC6 0%, #2a9da6 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .query-button:hover {
            background: linear-gradient(135deg, #2a9da6 0%, #238a92 100%);
            box-shadow: 0 2px 8px rgba(60, 187, 198, 0.3);
        }

        .query-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .secondary-button {
            flex: 1;
            padding: 0.75rem;
            background: white;
            color: #3CBBC6;
            border: 1px solid #3CBBC6;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .secondary-button:hover {
            background: #f0f9fa;
        }

        /* çµæœè¡¨æ ¼å€å¡Š */
        .results-section {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .results-header {
            background-color: #e8f5e9;
            padding: 1rem 1.5rem;
            font-weight: 600;
            color: #2e7d32;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }

        .results-header:hover {
            background-color: #dcedc8;
        }

        .toggle-icon {
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 12px solid #2e7d32;
            transition: transform 0.3s;
        }

        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        .results-table-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-table th {
            background-color: #f5f5f5;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            color: #666;
            border-bottom: 2px solid #ddd;
        }

        .results-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        .results-table tr:hover {
            background-color: #f9f9f9;
        }

        .results-table a {
            color: #3CBBC6;
            text-decoration: none;
        }

        .results-table a:hover {
            text-decoration: underline;
        }

        /* éŒ¯èª¤è¨Šæ¯ */
        .error-message {
            background-color: #ffebee;
            color: #c62828;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            font-size: 0.9rem;
            border-left: 4px solid #c62828;
        }

        /* èªªæ˜å½ˆçª— */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 12px;
            position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        .modal-content h2 {
            margin-top: 0;
            color: #3CBBC6;
        }

        .modal-content ul {
            padding-left: 1.5rem;
        }

        .modal-content li {
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }

        /* æ»¾å‹•æ¢æ¨£å¼ */
        .sidebar-content::-webkit-scrollbar,
        .results-table-container::-webkit-scrollbar,
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .sidebar-content::-webkit-scrollbar-track,
        .results-table-container::-webkit-scrollbar-track,
        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .sidebar-content::-webkit-scrollbar-thumb,
        .results-table-container::-webkit-scrollbar-thumb,
        .modal-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .sidebar-content::-webkit-scrollbar-thumb:hover,
        .results-table-container::-webkit-scrollbar-thumb:hover,
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Marker è¨­å®šæŒ‰éˆ• */
        .marker-settings-btn {
            position: absolute;
            bottom: 20px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 0.75rem;
            width: 46px;
            height: 46px;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            color: #3CBBC6;
            border: 1px solid #3CBBC6;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }

        .marker-settings-btn:hover {
            background: #f0f9fa;
            transform: scale(1.05);
        }

        /* Marker è¨­å®šé¢æ¿ */
        .marker-settings-panel {
            display: none;
            position: absolute;
            bottom: 80px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 1.5rem;
            max-width: 300px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }

        .marker-settings-panel.show {
            display: block;
        }

        .settings-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .settings-panel-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }

        .settings-close-btn {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: #666;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .settings-close-btn:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        .settings-group {
            margin-bottom: 1rem;
        }

        .settings-group-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: #555;
            margin-bottom: 0.5rem;
        }

        .settings-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .color-options {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .color-option.selected {
            border-color: #333;
            transform: scale(1.1);
        }

        .settings-submit-btn {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, #3CBBC6 0%, #2a9da6 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.3s ease;
        }

        .settings-submit-btn:hover {
            background: linear-gradient(135deg, #2a9da6 0%, #238a92 100%);
        }

        /* è¼‰å…¥å‹•ç•« */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3CBBC6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- é ‚éƒ¨æ¨™é¡Œ -->
    <div class="header">
        <div class="header-title">
            <span>ğŸ </span>
            <span>HRE åœ°è™Ÿåº§æ¨™æŸ¥è©¢ç³»çµ±</span>
        </div>
        <button class="help-btn" id="showHelpBtn">ğŸ“– ä½¿ç”¨èªªæ˜</button>
    </div>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <div class="main-container">
        <!-- å·¦å´æŸ¥è©¢å€åŸŸ -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-toggle-btn" id="sidebarToggleBtn">â€¹</div>
            <div class="sidebar-content">
                <!-- æŸ¥è©¢è¡¨å–® -->
                <div class="query-section">
                    <h3 class="section-title">å¤šç­†åœ°è™ŸæŸ¥è©¢</h3>

                    <form id="queryForm">
                        <label class="form-label">è¼¸å…¥åœ°è™Ÿ (ç”¨é€—è™Ÿæˆ–æ›è¡Œåˆ†éš”)</label>
                        <textarea
                            class="land-input"
                            id="landInput"
                            placeholder="ä¾‹å¦‚ï¼šè‡ºåŒ—å¸‚ä¿¡ç¾©æ®µä¸‰å°æ®µ13åœ°è™Ÿ, è‡ºåŒ—å¸‚ä¿¡ç¾©æ®µä¸‰å°æ®µ25åœ°è™Ÿ, è‡ºåŒ—å¸‚ä¿¡ç¾©æ®µä¸‰å°æ®µ39åœ°è™Ÿ"
                        ></textarea>

                        <div class="button-group">
                            <button type="submit" class="query-button" id="queryBtn">
                                <span>ğŸ” æŸ¥è©¢ä¸¦é¡¯ç¤ºåœ°åœ–</span>
                            </button>
                            <button type="button" class="secondary-button" id="exampleBtn">
                                ğŸ’¡ å¡«å…¥ç¯„ä¾‹
                            </button>
                        </div>
                    </form>

                    <!-- éŒ¯èª¤è¨Šæ¯å®¹å™¨ -->
                    <div id="errorContainer"></div>
                </div>

                <!-- æŸ¥è©¢çµæœ -->
                <div class="results-section" id="resultsSection" style="display: none;">
                    <div class="results-header" id="resultsToggle">
                        <span>æŸ¥è©¢çµæœ</span>
                        <div class="toggle-icon" id="toggleIcon"></div>
                    </div>
                    <div class="results-table-container" id="resultsContainer">
                        <!-- çµæœå°‡å‹•æ…‹æ’å…¥é€™è£¡ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- å³å´åœ°åœ–å€åŸŸ -->
        <div class="map-container">
            <!-- åœ°åœ–æ§åˆ¶æŒ‰éˆ• -->
            <div class="map-controls">
                <button class="map-control-btn" id="toggleMarkersBtn">æ¨™è¨˜</button>
                <button class="map-control-btn" id="toggleShapesBtn">æ¡†ç·š</button>
                <button class="map-control-btn" id="toggleFirstBtn">ç¬¬ä¸€ç­†</button>
                <button class="map-control-btn" id="screenshotBtn">ğŸ“· æˆªåœ–</button>
                <div class="marker-style-dropdown">
                    <button class="map-control-btn" id="markerStyleBtn">æ¨™è¨˜æ¨£å¼ â–¾</button>
                    <div class="marker-style-menu" id="markerStyleMenu">
                        <div class="marker-style-option" data-style="text">
                            <span class="marker-style-icon">ğŸ“</span>
                            <span>æ–‡å­—æ¨™ç±¤</span>
                        </div>
                        <div class="marker-style-option" data-style="pin">
                            <span class="marker-style-icon">ğŸ“</span>
                            <span>æ¨™æº– Marker</span>
                        </div>
                        <div class="marker-style-option" data-style="pin-text">
                            <span class="marker-style-icon">ğŸ·ï¸</span>
                            <span>Marker + æ–‡å­—</span>
                        </div>
                        <div class="marker-style-option" data-style="dot">
                            <span class="marker-style-icon">âš«</span>
                            <span>å°åœ“é»</span>
                        </div>
                        <div class="marker-style-option active" data-style="leader-line">
                            <span class="marker-style-icon">ğŸ”—</span>
                            <span>å¼•å°ç·šæ¨™ç±¤</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Marker è¨­å®šæŒ‰éˆ• -->
            <button class="marker-settings-btn" id="markerSettingsBtn" title="æ¨™è¨˜è¨­å®š">âš™ï¸</button>

            <!-- æ–‡å­—å¤§å°æ§åˆ¶ -->
            <div class="text-size-control">
                <div class="text-size-label">
                    <span>æ–‡å­—å¤§å°</span>
                    <span class="text-size-value" id="textSizeValue">16px</span>
                </div>
                <input type="range"
                       class="text-size-slider"
                       id="textSizeSlider"
                       min="10"
                       max="24"
                       value="16"
                       step="1">
                <div class="text-size-presets">
                    <button class="text-size-preset-btn" data-size="12">å°</button>
                    <button class="text-size-preset-btn" data-size="16">ä¸­</button>
                    <button class="text-size-preset-btn" data-size="20">å¤§</button>
                    <button class="text-size-preset-btn" data-size="24">ç‰¹å¤§</button>
                </div>
            </div>

            <!-- Marker è¨­å®šé¢æ¿ -->
            <div class="marker-settings-panel" id="markerSettingsPanel">
                <div class="settings-panel-header">
                    <div class="settings-panel-title">æ¨™è¨˜è¨­å®š</div>
                    <button class="settings-close-btn" id="settingsCloseBtn">Ã—</button>
                </div>

                <div class="settings-group">
                    <div class="settings-group-title">å‹˜ä¼°æ¨™çš„</div>
                    <input type="text" class="settings-input" id="marker1Text" value="å‹˜ä¼°æ¨™çš„" placeholder="æ¨™è¨˜æ–‡å­—">
                    <div class="color-options">
                        <div class="color-option selected" style="background-color: #ef5350;" data-color="#ef5350" data-target="marker1"></div>
                        <div class="color-option" style="background-color: #42a5f5;" data-color="#42a5f5" data-target="marker1"></div>
                        <div class="color-option" style="background-color: #66bb6a;" data-color="#66bb6a" data-target="marker1"></div>
                        <div class="color-option" style="background-color: #ffa726;" data-color="#ffa726" data-target="marker1"></div>
                        <div class="color-option" style="background-color: #ab47bc;" data-color="#ab47bc" data-target="marker1"></div>
                    </div>
                </div>

                <div class="settings-group">
                    <div class="settings-group-title">æ¯”è¼ƒæ¨™çš„</div>
                    <input type="text" class="settings-input" id="marker2Text" value="æ¯”è¼ƒæ¨™çš„" placeholder="æ¨™è¨˜æ–‡å­—">
                    <div class="color-options">
                        <div class="color-option" style="background-color: #ef5350;" data-color="#ef5350" data-target="marker2"></div>
                        <div class="color-option selected" style="background-color: #42a5f5;" data-color="#42a5f5" data-target="marker2"></div>
                        <div class="color-option" style="background-color: #66bb6a;" data-color="#66bb6a" data-target="marker2"></div>
                        <div class="color-option" style="background-color: #ffa726;" data-color="#ffa726" data-target="marker2"></div>
                        <div class="color-option" style="background-color: #ab47bc;" data-color="#ab47bc" data-target="marker2"></div>
                    </div>
                    <label style="font-size: 0.85rem; color: #666; margin-top: 0.5rem; display: block;">
                        èµ·å§‹ç·¨è™Ÿ: <input type="number" class="settings-input" id="marker2Start" value="1" min="1" style="width: 60px; display: inline-block; margin-left: 0.5rem;">
                    </label>
                </div>

                <div class="settings-group">
                    <div class="settings-group-title">ğŸ”— å¼•å°ç·šè¨­å®š</div>
                    <label style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem; display: block;">
                        ç·šæ¢ç²—ç´°: <span id="lineWidthValue" style="color: #3CBBC6; font-weight: 600;">4px</span>
                    </label>
                    <input type="range" class="settings-input" id="lineWidthSlider" min="1" max="5" value="4" step="1" style="width: 100%;">

                    <label style="font-size: 0.85rem; color: #666; margin-top: 0.75rem; margin-bottom: 0.5rem; display: block;">
                        ç·šæ¢é¡è‰²:
                    </label>
                    <div class="color-options">
                        <div class="color-option selected" style="background-color: #333333;" data-color="#333333" data-target="line" title="æ·±ç°"></div>
                        <div class="color-option" style="background-color: #666666;" data-color="#666666" data-target="line" title="ç°è‰²"></div>
                        <div class="color-option" style="background-color: #999999;" data-color="#999999" data-target="line" title="æ·ºç°"></div>
                        <div class="color-option" style="background-color: #ef5350;" data-color="#ef5350" data-target="line" title="ç´…è‰²"></div>
                        <div class="color-option" style="background-color: #42a5f5;" data-color="#42a5f5" data-target="line" title="è—è‰²"></div>
                    </div>

                    <label style="font-size: 0.85rem; color: #666; margin-top: 0.75rem; margin-bottom: 0.5rem; display: block;">
                        é€æ˜åº¦: <span id="lineOpacityValue" style="color: #3CBBC6; font-weight: 600;">20%</span>
                    </label>
                    <input type="range" class="settings-input" id="lineOpacitySlider" min="0" max="70" value="20" step="10" style="width: 100%;">
                </div>

                <button class="settings-submit-btn" id="settingsSubmitBtn">å¥—ç”¨è¨­å®š</button>
            </div>

            <div id="map"></div>
        </div>
    </div>

    <!-- èªªæ˜å½ˆçª— -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <button class="modal-close" id="closeHelpBtn">Ã—</button>
            <h2>ğŸ“– ä½¿ç”¨èªªæ˜</h2>

            <h4>æ”¯æ´çš„åœ°è™Ÿæ ¼å¼ç¯„ä¾‹</h4>
            <ul>
                <li>è‡ºåŒ—å¸‚ä¿¡ç¾©æ®µä¸‰å°æ®µ13åœ°è™Ÿ</li>
                <li>è‡ºåŒ—å¸‚ä¿¡ç¾©æ®µä¸‰å°æ®µ25åœ°è™Ÿ</li>
                <li>è‡ºåŒ—å¸‚ä¿¡ç¾©æ®µä¸‰å°æ®µ39åœ°è™Ÿ</li>
                <li>è‡ºåŒ—å¸‚ä¿¡ç¾©æ®µä¸€å°æ®µ1åœ°è™Ÿ</li>
            </ul>

            <h4>âš ï¸ æ³¨æ„äº‹é …</h4>
            <ul>
                <li>è¼¸å…¥æ™‚å¯åŒ…å«ã€Œåœ°è™Ÿã€é—œéµå­—ï¼Œç³»çµ±æœƒè‡ªå‹•è½‰æ›æˆ API æ”¯æ´çš„æ ¼å¼</li>
                <li>æŸ¥è©¢æ™‚ä¸éœ€æ’°å¯«ä¾‹å¦‚ã€Œä¿¡ç¾©å€ã€ç­‰è¡Œæ”¿å€åç¨±</li>
                <li>è«‹æ³¨æ„ï¼Œå¯èƒ½æœƒå› åŒä¸€ç¸£å¸‚æœ‰ç›¸åŒã€Œæ®µåã€çš„åœŸåœ°è€Œç”¢ç”Ÿé‡è¤‡çµæœ</li>
                <li>å¤šç­†æŸ¥è©¢æ™‚ï¼Œå¯ä½¿ç”¨é€—è™Ÿæˆ–æ›è¡Œåˆ†éš”</li>
            </ul>

            <h4>ğŸ—ºï¸ åœ°åœ–åŠŸèƒ½</h4>
            <ul>
                <li><strong>æ¨™è¨˜ï¼š</strong>åˆ‡æ›é¡¯ç¤º/éš±è—æ‰€æœ‰åœ°è™Ÿæ¨™è¨˜</li>
                <li><strong>æ¡†ç·šï¼š</strong>åˆ‡æ›é¡¯ç¤º/éš±è—åœŸåœ°ç¯„åœæ¡†ç·š</li>
                <li><strong>ç¬¬ä¸€ç­†ï¼š</strong>åˆ‡æ›é¡¯ç¤º/éš±è—ç¬¬ä¸€ç­†æ¨™çš„</li>
                <li><strong>æ–‡å­—ï¼š</strong>åˆ‡æ›æ¨™è¨˜æ–‡å­—é¡¯ç¤º</li>
                <li><strong>æ¨™è¨˜è¨­å®šï¼š</strong>è‡ªè¨‚æ¨™è¨˜æ¨£å¼ã€é¡è‰²èˆ‡ç·¨è™Ÿ</li>
            </ul>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dom-to-image-more@2.8.0/dist/dom-to-image-more.min.js"></script>

    <script>
        // ==================== å…¨åŸŸè®Šæ•¸ ====================
        let map;
        let officeMarker;
        let firstMarkerGroup = L.layerGroup();
        let otherMarkerGroup = L.layerGroup();
        let firstShapeGroup = L.layerGroup();
        let otherShapeGroup = L.layerGroup();
        let showMarkerText = true;
        let markerCounter = 1;

        // æ¨™è¨˜è¨­å®š
        let marker1Color = '#ef5350';
        let marker2Color = '#42a5f5';
        let marker1Text = 'å‹˜ä¼°æ¨™çš„';
        let marker2Text = 'æ¯”è¼ƒæ¨™çš„';
        let marker2StartNum = 1;
        let currentMarkerStyle = 'leader-line'; // 'text', 'pin', 'pin-text', 'dot', 'leader-line'
        let markerTextSize = 16; // é è¨­æ–‡å­—å¤§å°

        // å„²å­˜ç•¶å‰æŸ¥è©¢çš„åœŸåœ°è³‡æ–™ï¼ˆç”¨æ–¼æˆªåœ–æª”åï¼‰
        let currentLandData = null;

        // å„²å­˜æ‰€æœ‰æ¨™ç±¤çš„é‚Šç•Œæ¡†ï¼Œç”¨æ–¼ç¢°æ’åµæ¸¬
        let labelBounds = [];

        // å„²å­˜æ‰€æœ‰å¼•å°ç·šæ¨™ç±¤ï¼Œç”¨æ–¼ç£åŠ›æ’æ–¥æ•ˆæœ
        let allLeaderLineMarkers = [];

        // ç£åŠ›æ’æ–¥åƒæ•¸ï¼ˆèª¿æ•´ç‚ºæ›´æº«å’Œçš„è¨­å®šï¼‰
        const REPULSION_STRENGTH = 0.00003; // æ’æ–¥åŠ›å¼·åº¦ï¼ˆé™ä½ï¼‰
        const REPULSION_DISTANCE = 0.002;   // æ’æ–¥åŠ›ä½œç”¨è·é›¢ï¼ˆç¸®çŸ­ï¼‰
        const DAMPING = 0.3;                 // é˜»å°¼ä¿‚æ•¸ï¼ˆå¢åŠ é˜»å°¼ï¼Œæ¸›é€Ÿæ›´å¿«ï¼‰
        const MIN_DISTANCE = 0.0006;         // æœ€å°è·é›¢é–¾å€¼

        // å¼•å°ç·šè¨­å®š
        let leaderLineWidth = 4; // å¼•å°ç·šç²—ç´°ï¼ˆ1-5ï¼‰
        let leaderLineColor = '#333333'; // å¼•å°ç·šé¡è‰²
        let leaderLineOpacity = 0.8; // å¼•å°ç·šä¸é€æ˜åº¦ï¼ˆopacityï¼Œé€æ˜åº¦ 20% = ä¸é€æ˜åº¦ 80%ï¼‰

        // ç¯„ä¾‹è³‡æ–™é›†
        const sampleSets = [
            "è‡ºåŒ—å¸‚ä¿¡ç¾©æ®µä¸‰å°æ®µ13åœ°è™Ÿ, è‡ºåŒ—å¸‚ä¿¡ç¾©æ®µä¸‰å°æ®µ25åœ°è™Ÿ, è‡ºåŒ—å¸‚ä¿¡ç¾©æ®µä¸‰å°æ®µ39åœ°è™Ÿ, è‡ºåŒ—å¸‚ä¿¡ç¾©æ®µä¸‰å°æ®µ49åœ°è™Ÿ, è‡ºåŒ—å¸‚ä¿¡ç¾©æ®µä¸€å°æ®µ1åœ°è™Ÿ",
            "é€£æ±Ÿç¸£æ¸…æ°´æ®µ650åœ°è™Ÿ,é€£æ±Ÿç¸£æ¸…æ°´æ®µ600åœ°è™Ÿ,é€£æ±Ÿç¸£æ¸…æ°´æ®µ700-1åœ°è™Ÿ,é€£æ±Ÿç¸£æ¸…æ°´æ®µ500åœ°è™Ÿ",
            "è‡ºåŒ—å¸‚å¤©å±±æ®µä¸€å°æ®µ3-1åœ°è™Ÿ, è‡ºåŒ—å¸‚å¤©å±±æ®µäºŒå°æ®µ1-1åœ°è™Ÿ, è‡ºåŒ—å¸‚å¤©å±±æ®µä¸€å°æ®µ20-1åœ°è™Ÿ,è‡ºåŒ—å¸‚å¤©å±±æ®µäºŒå°æ®µ25åœ°è™Ÿ"
        ];

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            initializeEventListeners();
        });

        // åˆå§‹åŒ–åœ°åœ–
        function initializeMap() {
            map = L.map('map').setView([25.0722096, 121.5120364], 16);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // æ·»åŠ åœ–å±¤
            firstMarkerGroup.addTo(map);
            otherMarkerGroup.addTo(map);
            firstShapeGroup.addTo(map);
            otherShapeGroup.addTo(map);

            // æ·»åŠ å…¬å¸ä½ç½®æ¨™è¨˜
            const houseIcon = L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/25/25694.png',
                iconSize: [35, 35],
                iconAnchor: [17.5, 35],
                popupAnchor: [0, -35]
            });

            officeMarker = L.marker([25.0722096, 121.5120364], {
                icon: houseIcon,
                draggable: true
            }).addTo(map);

            officeMarker.bindPopup("<b style='font-size:14px;'>æ¼¢å¨œä¸å‹•ç”¢ä¼°åƒ¹å¸«è¯åˆäº‹å‹™æ‰€</b>").openPopup();
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›£è½å™¨
        function initializeEventListeners() {
            // è¡¨å–®æäº¤
            document.getElementById('queryForm').addEventListener('submit', handleQuery);

            // å¡«å…¥ç¯„ä¾‹
            document.getElementById('exampleBtn').addEventListener('click', fillRandomExample);

            // èªªæ˜å½ˆçª—
            document.getElementById('showHelpBtn').addEventListener('click', () => {
                document.getElementById('helpModal').classList.add('show');
            });

            document.getElementById('closeHelpBtn').addEventListener('click', () => {
                document.getElementById('helpModal').classList.remove('show');
            });

            document.getElementById('helpModal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('helpModal')) {
                    document.getElementById('helpModal').classList.remove('show');
                }
            });

            // çµæœè¡¨æ ¼æŠ˜ç–Š
            document.getElementById('resultsToggle').addEventListener('click', toggleResults);

            // åœ°åœ–æ§åˆ¶æŒ‰éˆ•
            document.getElementById('toggleMarkersBtn').addEventListener('click', toggleMarkers);
            document.getElementById('toggleShapesBtn').addEventListener('click', toggleShapes);
            document.getElementById('toggleFirstBtn').addEventListener('click', toggleFirstMarker);
            document.getElementById('screenshotBtn').addEventListener('click', takeMapScreenshot);

            // æ¨™è¨˜æ¨£å¼é¸å–®
            document.getElementById('markerStyleBtn').addEventListener('click', function(e) {
                e.stopPropagation();
                document.getElementById('markerStyleMenu').classList.toggle('show');
            });

            // é»æ“Šå¤–éƒ¨é—œé–‰é¸å–®
            document.addEventListener('click', function(e) {
                const menu = document.getElementById('markerStyleMenu');
                const btn = document.getElementById('markerStyleBtn');
                if (!menu.contains(e.target) && e.target !== btn) {
                    menu.classList.remove('show');
                }
            });

            // æ¨™è¨˜æ¨£å¼é¸é …
            document.querySelectorAll('.marker-style-option').forEach(option => {
                option.addEventListener('click', function() {
                    const style = this.dataset.style;
                    currentMarkerStyle = style;

                    // æ›´æ–° active ç‹€æ…‹
                    document.querySelectorAll('.marker-style-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    this.classList.add('active');

                    // é—œé–‰é¸å–®
                    document.getElementById('markerStyleMenu').classList.remove('show');

                    // æ›´æ–°æ¨™è¨˜æ¨£å¼
                    updateAllMarkers();
                });
            });

            // æ¨™è¨˜è¨­å®šé¢æ¿
            document.getElementById('markerSettingsBtn').addEventListener('click', toggleSettingsPanel);
            document.getElementById('settingsCloseBtn').addEventListener('click', closeSettingsPanel);
            document.getElementById('settingsSubmitBtn').addEventListener('click', applyMarkerSettings);

            // é¡è‰²é¸æ“‡
            document.querySelectorAll('.color-option').forEach(option => {
                option.addEventListener('click', function() {
                    const target = this.dataset.target;
                    const color = this.dataset.color;

                    // ç§»é™¤åŒçµ„å…¶ä»–é¸é …çš„ selected class
                    document.querySelectorAll(`.color-option[data-target="${target}"]`).forEach(opt => {
                        opt.classList.remove('selected');
                    });

                    // æ·»åŠ  selected class åˆ°ç•¶å‰é¸é …
                    this.classList.add('selected');
                });
            });

            // æ–‡å­—å¤§å°æ§åˆ¶
            const textSizeSlider = document.getElementById('textSizeSlider');
            const textSizeValue = document.getElementById('textSizeValue');

            textSizeSlider.addEventListener('input', function() {
                markerTextSize = parseInt(this.value);
                textSizeValue.textContent = markerTextSize + 'px';
                updateAllMarkers();
            });

            // é è¨­å¤§å°æŒ‰éˆ•
            document.querySelectorAll('.text-size-preset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const size = parseInt(this.dataset.size);
                    markerTextSize = size;
                    textSizeSlider.value = size;
                    textSizeValue.textContent = size + 'px';
                    updateAllMarkers();
                });
            });

            // å¼•å°ç·šç²—ç´°æ§åˆ¶
            const lineWidthSlider = document.getElementById('lineWidthSlider');
            const lineWidthValue = document.getElementById('lineWidthValue');

            lineWidthSlider.addEventListener('input', function() {
                const width = parseInt(this.value);
                lineWidthValue.textContent = width + 'px';
            });

            // å¼•å°ç·šé€æ˜åº¦æ§åˆ¶
            const lineOpacitySlider = document.getElementById('lineOpacitySlider');
            const lineOpacityValue = document.getElementById('lineOpacityValue');

            lineOpacitySlider.addEventListener('input', function() {
                const transparency = parseInt(this.value); // é€æ˜åº¦ç™¾åˆ†æ¯”ï¼ˆ0-70ï¼‰
                lineOpacityValue.textContent = transparency + '%';
            });

            // å´é‚Šæ¬„æ‘ºç–ŠåŠŸèƒ½
            document.getElementById('sidebarToggleBtn').addEventListener('click', toggleSidebar);
        }

        // åˆ‡æ›å´é‚Šæ¬„æ‘ºç–Šç‹€æ…‹
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebarToggleBtn');

            sidebar.classList.toggle('collapsed');

            // åˆ‡æ›æŒ‰éˆ•ç®­é ­æ–¹å‘
            if (sidebar.classList.contains('collapsed')) {
                toggleBtn.textContent = 'â€º';
            } else {
                toggleBtn.textContent = 'â€¹';
            }
        }

        // åˆ‡æ›è¨­å®šé¢æ¿
        function toggleSettingsPanel() {
            const panel = document.getElementById('markerSettingsPanel');
            panel.classList.toggle('show');
        }

        // é—œé–‰è¨­å®šé¢æ¿
        function closeSettingsPanel() {
            document.getElementById('markerSettingsPanel').classList.remove('show');
        }

        // å¥—ç”¨æ¨™è¨˜è¨­å®š
        function applyMarkerSettings() {
            // å–å¾—è¨­å®šå€¼
            marker1Text = document.getElementById('marker1Text').value || 'å‹˜ä¼°æ¨™çš„';
            marker2Text = document.getElementById('marker2Text').value || 'æ¯”è¼ƒæ¨™çš„';
            marker2StartNum = parseInt(document.getElementById('marker2Start').value) || 1;

            // å–å¾—é¸ä¸­çš„é¡è‰²
            const marker1ColorOption = document.querySelector('.color-option[data-target="marker1"].selected');
            const marker2ColorOption = document.querySelector('.color-option[data-target="marker2"].selected');
            const lineColorOption = document.querySelector('.color-option[data-target="line"].selected');

            if (marker1ColorOption) marker1Color = marker1ColorOption.dataset.color;
            if (marker2ColorOption) marker2Color = marker2ColorOption.dataset.color;
            if (lineColorOption) leaderLineColor = lineColorOption.dataset.color;

            // å–å¾—å¼•å°ç·šè¨­å®š
            leaderLineWidth = parseInt(document.getElementById('lineWidthSlider').value) || 2;
            const transparency = parseInt(document.getElementById('lineOpacitySlider').value) || 70; // é€æ˜åº¦ç™¾åˆ†æ¯”
            leaderLineOpacity = 1 - (transparency / 100); // è½‰æ›ç‚º opacity å€¼

            // é‡æ–°æ¸²æŸ“æ¨™è¨˜
            updateAllMarkers();

            // é—œé–‰é¢æ¿
            closeSettingsPanel();
        }

        // æ›´æ–°æ‰€æœ‰æ¨™è¨˜
        function updateAllMarkers() {
            const markers = [];

            // æ¸…ç©ºæ¨™ç±¤é‚Šç•Œæ¡†é™£åˆ—ï¼Œé‡æ–°è¨ˆç®—ç¢°æ’åµæ¸¬
            labelBounds = [];

            // æ¸…ç©ºå¼•å°ç·šæ¨™ç±¤é™£åˆ—
            allLeaderLineMarkers = [];

            // æ”¶é›†æ‰€æœ‰æ¨™è¨˜è³‡è¨Š
            firstMarkerGroup.eachLayer(marker => {
                let latLng;
                if (marker.centerLatLng) {
                    // leader-line é¡å‹æœ‰ centerLatLng å±¬æ€§
                    latLng = marker.centerLatLng;
                } else if (typeof marker.getLatLng === 'function') {
                    // æ™®é€š marker æœ‰ getLatLng æ–¹æ³•
                    latLng = marker.getLatLng();
                } else {
                    console.warn('ç„¡æ³•ç²å–ç¬¬ä¸€ç­†æ¨™è¨˜åº§æ¨™', marker);
                    return;
                }
                markers.push({ marker, isFirst: true, latLng: latLng });
            });

            let counter = marker2StartNum;
            otherMarkerGroup.eachLayer(marker => {
                let latLng;
                if (marker.centerLatLng) {
                    // leader-line é¡å‹æœ‰ centerLatLng å±¬æ€§
                    latLng = marker.centerLatLng;
                } else if (typeof marker.getLatLng === 'function') {
                    // æ™®é€š marker æœ‰ getLatLng æ–¹æ³•
                    latLng = marker.getLatLng();
                } else {
                    console.warn('ç„¡æ³•ç²å–æ¯”è¼ƒæ¨™çš„åº§æ¨™', marker);
                    return;
                }
                markers.push({ marker, isFirst: false, latLng: latLng, counter: counter++ });
            });

            // æ¸…ç©ºåœ–å±¤
            firstMarkerGroup.clearLayers();
            otherMarkerGroup.clearLayers();

            // é‡æ–°å‰µå»ºæ¨™è¨˜
            markers.forEach(({ latLng, isFirst, counter }) => {
                const label = isFirst ? marker1Text : `${marker2Text}${counter}`;
                const newMarker = createMarker(latLng.lat, latLng.lng, label, isFirst);

                if (isFirst) {
                    firstMarkerGroup.addLayer(newMarker);
                } else {
                    otherMarkerGroup.addLayer(newMarker);
                }
            });

            // æš«æ™‚é—œé–‰ç£åŠ›æ’æ–¥ï¼Œä½¿ç”¨ç¢°æ’åµæ¸¬å³å¯
            // setTimeout(() => {
            //     applyMagneticRepulsion(10);
            // }, 100);
        }

        // ==================== æŸ¥è©¢è™•ç† ====================
        async function handleQuery(event) {
            event.preventDefault();

            clearError();

            const landInput = document.getElementById('landInput').value;

            if (!landInput.trim()) {
                showError('è«‹è¼¸å…¥è‡³å°‘ä¸€ç­†åœ°è™Ÿï¼');
                return;
            }

            showLoading(true);

            try {
                // è™•ç†åœ°è™Ÿæ ¼å¼
                const landList = landInput
                    .split(/[,ï¼Œ\n]+/)
                    .map(item => formatLandInput(item.trim()))
                    .filter(Boolean);

                if (landList.length === 0) {
                    throw new Error('è¼¸å…¥æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºèªåœ°è™Ÿæ˜¯å¦æ­£ç¢ºã€‚');
                }

                // å‘¼å« API
                const apiUrl = `https://twland.ronny.tw/index/search?${landList
                    .map(land => `lands[]=${encodeURIComponent(land)}`)
                    .join('&')}`;

                console.log("API æŸ¥è©¢ï¼š", apiUrl);

                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`API è«‹æ±‚å¤±æ•—ï¼š${response.status}`);

                const data = await response.json();

                if (data.notfound && data.notfound.length > 0) {
                    const notFoundList = data.notfound.map(obj => obj.query).filter(Boolean);
                    if (notFoundList.length > 0) {
                        throw new Error(`ä»¥ä¸‹åœ°è™ŸæŸ¥ç„¡è³‡æ–™ï¼š${notFoundList.join(', ')}`);
                    }
                }

                // é¡¯ç¤ºçµæœ
                displayResults(data);

            } catch (error) {
                console.error('æŸ¥è©¢éŒ¯èª¤:', error);
                showError(error.message || 'æŸ¥è©¢éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
            } finally {
                showLoading(false);
            }
        }

        // æ ¼å¼åŒ–åœ°è™Ÿè¼¸å…¥
        function formatLandInput(input) {
            const replacements = {
                "å°åŒ—": "è‡ºåŒ—",
                "å°ä¸­": "è‡ºä¸­",
                "å°å—": "è‡ºå—",
                "å°æ±": "è‡ºæ±"
            };

            Object.keys(replacements).forEach(key => {
                input = input.replace(new RegExp(key, 'g'), replacements[key]);
            });

            return input.replace(/åœ°è™Ÿ$/, 'è™Ÿ').trim();
        }

        // æ ¼å¼åŒ–åœ°è™Ÿé¡¯ç¤º
        function formatLandNumber(landNumber) {
            const landStr = landNumber.toString().padStart(8, '0');
            const motherNumber = parseInt(landStr.slice(0, 4), 10);
            const childNumber = parseInt(landStr.slice(4), 10);
            return childNumber === 0 ? `${motherNumber}` : `${motherNumber}-${childNumber}`;
        }

        // ==================== é¡¯ç¤ºçµæœ ====================
        function displayResults(data) {
            // æ¸…ç©ºåœ°åœ–åœ–å±¤
            firstMarkerGroup.clearLayers();
            otherMarkerGroup.clearLayers();
            firstShapeGroup.clearLayers();
            otherShapeGroup.clearLayers();

            // æ¸…ç©ºæ¨™ç±¤é‚Šç•Œæ¡†é™£åˆ—ï¼Œé‡æ–°è¨ˆç®—ç¢°æ’åµæ¸¬
            labelBounds = [];

            // æ¸…ç©ºå¼•å°ç·šæ¨™ç±¤é™£åˆ—
            allLeaderLineMarkers = [];

            // å»ºç«‹è¡¨æ ¼
            let tableHTML = `
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>ç·¨è™Ÿ</th>
                            <th>ç¸£å¸‚</th>
                            <th>é„‰é®</th>
                            <th>åœ°æ®µ</th>
                            <th>åœ°è™Ÿ</th>
                            <th>ç¶“ç·¯åº¦åº§æ¨™</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            let otherCounter = marker2StartNum;

            data.features.forEach((feature, index) => {
                const props = feature.properties;
                // ä¿æŒæ•¸å­—é¡å‹ç”¨æ–¼å‰µå»ºæ¨™è¨˜ï¼Œé¿å…å­—ä¸²ä¸²æ¥å•é¡Œ
                const latNum = props.ycenter;
                const lngNum = props.xcenter;
                // è½‰æ›æˆå­—ä¸²ç”¨æ–¼é¡¯ç¤º
                const lat = latNum.toFixed(6);
                const lng = lngNum.toFixed(6);
                const coords = `${lat},${lng}`;
                const googleMapsLink = `https://www.google.com/maps/place/${coords}`;
                const formattedLandNumber = formatLandNumber(props["åœ°è™Ÿ"]);

                // æ·»åŠ è¡¨æ ¼è¡Œ
                const label = index === 0 ? marker1Text : `${marker2Text}${otherCounter}`;
                if (index > 0) otherCounter++;

                tableHTML += `
                    <tr>
                        <td><strong>${label}</strong></td>
                        <td>${props["ç¸£å¸‚"]}</td>
                        <td>${props["é„‰é®"]}</td>
                        <td>${props["åœ°æ®µ"]}</td>
                        <td>${formattedLandNumber}</td>
                        <td><a href="${googleMapsLink}" target="_blank">${coords}</a></td>
                    </tr>
                `;

                // å‰µå»ºæ¨™è¨˜ - ä½¿ç”¨æ•¸å­—é¡å‹åº§æ¨™
                const marker = createMarker(latNum, lngNum, label, index === 0);
                const geoJsonLayer = L.geoJSON(feature);

                if (index === 0) {
                    // å„²å­˜ç¬¬ä¸€ç­†åœŸåœ°è³‡æ–™ç”¨æ–¼æˆªåœ–æª”å
                    currentLandData = {
                        city: props["ç¸£å¸‚"],
                        district: props["é„‰é®"],
                        section: props["åœ°æ®µ"],
                        landNumber: formattedLandNumber
                    };
                    firstMarkerGroup.addLayer(marker);
                    firstShapeGroup.addLayer(geoJsonLayer);
                } else {
                    otherMarkerGroup.addLayer(marker);
                    otherShapeGroup.addLayer(geoJsonLayer);
                }
            });

            tableHTML += '</tbody></table>';

            // é¡¯ç¤ºçµæœ
            document.getElementById('resultsContainer').innerHTML = tableHTML;
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('toggleIcon').classList.remove('collapsed');

            // èª¿æ•´åœ°åœ–è¦–é‡
            const bounds = L.latLngBounds([]);
            firstShapeGroup.eachLayer(layer => bounds.extend(layer.getBounds()));
            otherShapeGroup.eachLayer(layer => bounds.extend(layer.getBounds()));
            map.fitBounds(bounds);

            // æš«æ™‚é—œé–‰ç£åŠ›æ’æ–¥ï¼Œä½¿ç”¨ç¢°æ’åµæ¸¬å³å¯
            // setTimeout(() => {
            //     applyMagneticRepulsion(10);
            // }, 100);
        }

        // ==================== æ¨™ç±¤ç¢°æ’åµæ¸¬å‡½æ•¸ ====================

        // æª¢æŸ¥å…©å€‹çŸ©å½¢æ˜¯å¦é‡ç–Š
        function isOverlapping(bounds1, bounds2) {
            return !(bounds1.maxLat < bounds2.minLat ||
                    bounds1.minLat > bounds2.maxLat ||
                    bounds1.maxLng < bounds2.minLng ||
                    bounds1.minLng > bounds2.maxLng);
        }

        // è¨ˆç®—æ¨™ç±¤çš„é‚Šç•Œæ¡†ï¼ˆç¶“ç·¯åº¦ç¯„åœï¼‰
        function calculateLabelBounds(centerLat, centerLng, offsetLat, offsetLng) {
            const labelLat = centerLat + offsetLat;
            const labelLng = centerLng + offsetLng;

            // å‡è¨­æ¨™ç±¤å¯¬åº¦å’Œé«˜åº¦å°æ‡‰çš„ç¶“ç·¯åº¦ç¯„åœ
            // é€™äº›å€¼æ ¹æ“šæ–‡å­—å¤§å°èª¿æ•´
            const latRange = 0.0004 * (markerTextSize / 16); // æ ¹æ“šæ–‡å­—å¤§å°èª¿æ•´
            const lngRange = 0.0008 * (markerTextSize / 16);

            return {
                minLat: labelLat - latRange,
                maxLat: labelLat + latRange,
                minLng: labelLng - lngRange,
                maxLng: labelLng + lngRange,
                centerLat: labelLat,
                centerLng: labelLng
            };
        }

        // æ‰¾åˆ°ä¸é‡ç–Šçš„åç§»æ–¹å‘
        function findNonOverlappingOffset(centerLat, centerLng) {
            // å®šç¾©å¤šå€‹å¯èƒ½çš„åç§»æ–¹å‘ï¼ˆé †åºï¼šå³ä¸Šã€å³ä¸‹ã€å·¦ä¸Šã€å·¦ä¸‹ã€å³ã€å·¦ã€ä¸Šã€ä¸‹ï¼‰
            const offsetDirections = [
                { lat: 0.0008, lng: 0.0008 },   // å³ä¸Šï¼ˆé è¨­ï¼‰
                { lat: -0.0008, lng: 0.0008 },  // å³ä¸‹
                { lat: 0.0008, lng: -0.0008 },  // å·¦ä¸Š
                { lat: -0.0008, lng: -0.0008 }, // å·¦ä¸‹
                { lat: 0, lng: 0.0012 },        // å³
                { lat: 0, lng: -0.0012 },       // å·¦
                { lat: 0.0012, lng: 0 },        // ä¸Š
                { lat: -0.0012, lng: 0 }        // ä¸‹
            ];

            // å˜—è©¦æ¯å€‹æ–¹å‘
            for (const offset of offsetDirections) {
                const bounds = calculateLabelBounds(centerLat, centerLng, offset.lat, offset.lng);

                // æª¢æŸ¥æ˜¯å¦èˆ‡ç¾æœ‰æ¨™ç±¤é‡ç–Š
                let hasOverlap = false;
                for (const existingBounds of labelBounds) {
                    if (isOverlapping(bounds, existingBounds)) {
                        hasOverlap = true;
                        break;
                    }
                }

                // å¦‚æœä¸é‡ç–Šï¼Œä½¿ç”¨é€™å€‹æ–¹å‘
                if (!hasOverlap) {
                    labelBounds.push(bounds); // è¨˜éŒ„é€™å€‹æ¨™ç±¤çš„é‚Šç•Œæ¡†
                    return { lat: offset.lat, lng: offset.lng };
                }
            }

            // å¦‚æœæ‰€æœ‰æ–¹å‘éƒ½é‡ç–Šï¼Œä½¿ç”¨é è¨­æ–¹å‘ä¸¦å¢åŠ è·é›¢
            const defaultOffset = { lat: 0.0015, lng: 0.0015 };
            const bounds = calculateLabelBounds(centerLat, centerLng, defaultOffset.lat, defaultOffset.lng);
            labelBounds.push(bounds);
            return defaultOffset;
        }

        // ==================== ç£åŠ›æ’æ–¥æ¼”ç®—æ³• ====================

        // è¨ˆç®—å…©é»ä¹‹é–“çš„è·é›¢
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const dLat = lat2 - lat1;
            const dLng = lng2 - lng1;
            return Math.sqrt(dLat * dLat + dLng * dLng);
        }

        // è¨ˆç®—æ’æ–¥åŠ›
        function calculateRepulsionForce(marker1, marker2) {
            const pos1 = marker1.labelMarker.getLatLng();
            const pos2 = marker2.labelMarker.getLatLng();

            const distance = calculateDistance(pos1.lat, pos1.lng, pos2.lat, pos2.lng);

            // å¦‚æœè·é›¢å¤ªé ï¼Œä¸æ–½åŠ æ’æ–¥åŠ›
            if (distance > REPULSION_DISTANCE || distance < 0.00001) {
                return { lat: 0, lng: 0 };
            }

            // æ’æ–¥åŠ›å¤§å°èˆ‡è·é›¢æˆåæ¯”ï¼ˆè·é›¢è¶Šè¿‘ï¼ŒåŠ›è¶Šå¤§ï¼‰
            const forceMagnitude = REPULSION_STRENGTH / (distance * distance);

            // è¨ˆç®—åŠ›çš„æ–¹å‘ï¼ˆå¾ marker2 æŒ‡å‘ marker1ï¼‰
            const direction = {
                lat: (pos1.lat - pos2.lat) / distance,
                lng: (pos1.lng - pos2.lng) / distance
            };

            return {
                lat: direction.lat * forceMagnitude,
                lng: direction.lng * forceMagnitude
            };
        }

        // æ‡‰ç”¨ç£åŠ›æ’æ–¥åˆ°æ‰€æœ‰æ¨™ç±¤
        function applyMagneticRepulsion(iterations = 20) {
            if (allLeaderLineMarkers.length <= 1) return;

            for (let iter = 0; iter < iterations; iter++) {
                const forces = [];

                // ç‚ºæ¯å€‹æ¨™ç±¤åˆå§‹åŒ–åŠ›ç‚º 0
                allLeaderLineMarkers.forEach(() => {
                    forces.push({ lat: 0, lng: 0 });
                });

                // è¨ˆç®—æ¯å°æ¨™ç±¤ä¹‹é–“çš„æ’æ–¥åŠ›
                for (let i = 0; i < allLeaderLineMarkers.length; i++) {
                    for (let j = i + 1; j < allLeaderLineMarkers.length; j++) {
                        const force = calculateRepulsionForce(
                            allLeaderLineMarkers[i],
                            allLeaderLineMarkers[j]
                        );

                        // å°æ¨™ç±¤ i æ–½åŠ æ’æ–¥åŠ›
                        forces[i].lat += force.lat;
                        forces[i].lng += force.lng;

                        // å°æ¨™ç±¤ j æ–½åŠ ç›¸åçš„æ’æ–¥åŠ›
                        forces[j].lat -= force.lat;
                        forces[j].lng -= force.lng;
                    }
                }

                // æ‡‰ç”¨åŠ›åˆ°æ¨™ç±¤ä½ç½®
                allLeaderLineMarkers.forEach((marker, index) => {
                    const currentPos = marker.labelMarker.getLatLng();
                    const centerPos = marker.centerLatLng;

                    // è¨ˆç®—æ–°ä½ç½®
                    let newLat = currentPos.lat + forces[index].lat * DAMPING;
                    let newLng = currentPos.lng + forces[index].lng * DAMPING;

                    // é™åˆ¶æ¨™ç±¤ä¸èƒ½å¤ªé è¿‘ä¸­å¿ƒé»
                    const distToCenter = calculateDistance(centerPos.lat, centerPos.lng, newLat, newLng);
                    if (distToCenter < MIN_DISTANCE) {
                        const scale = MIN_DISTANCE / distToCenter;
                        newLat = centerPos.lat + (newLat - centerPos.lat) * scale;
                        newLng = centerPos.lng + (newLng - centerPos.lng) * scale;
                    }

                    // æ›´æ–°æ¨™ç±¤ä½ç½®
                    marker.labelMarker.setLatLng([newLat, newLng]);

                    // æ›´æ–°å¼•å°ç·š
                    marker.leaderLine.setLatLngs([centerPos, [newLat, newLng]]);
                });
            }
        }

        // æ‹–æ›³æ™‚çš„å³æ™‚æ’æ–¥æ•ˆæœ
        function setupDragRepulsion(marker) {
            let isDragging = false;
            let animationFrame = null;

            marker.labelMarker.on('dragstart', function() {
                isDragging = true;
                startRepulsionAnimation();
            });

            marker.labelMarker.on('drag', function(e) {
                const newPos = e.target.getLatLng();
                marker.leaderLine.setLatLngs([marker.centerLatLng, newPos]);
            });

            marker.labelMarker.on('dragend', function() {
                isDragging = false;
                if (animationFrame) {
                    cancelAnimationFrame(animationFrame);
                    animationFrame = null;
                }
            });

            function startRepulsionAnimation() {
                if (!isDragging) return;

                // è¨ˆç®—ä¸¦æ‡‰ç”¨æ’æ–¥åŠ›
                const forces = [];
                allLeaderLineMarkers.forEach(() => {
                    forces.push({ lat: 0, lng: 0 });
                });

                for (let i = 0; i < allLeaderLineMarkers.length; i++) {
                    for (let j = i + 1; j < allLeaderLineMarkers.length; j++) {
                        const force = calculateRepulsionForce(
                            allLeaderLineMarkers[i],
                            allLeaderLineMarkers[j]
                        );

                        forces[i].lat += force.lat;
                        forces[i].lng += force.lng;
                        forces[j].lat -= force.lat;
                        forces[j].lng -= force.lng;
                    }
                }

                // åªæ›´æ–°éæ­£åœ¨æ‹–æ›³çš„æ¨™ç±¤
                allLeaderLineMarkers.forEach((m, index) => {
                    if (m.labelMarker !== marker.labelMarker) {
                        const currentPos = m.labelMarker.getLatLng();
                        const centerPos = m.centerLatLng;

                        let newLat = currentPos.lat + forces[index].lat * DAMPING * 0.5;
                        let newLng = currentPos.lng + forces[index].lng * DAMPING * 0.5;

                        const distToCenter = calculateDistance(centerPos.lat, centerPos.lng, newLat, newLng);
                        if (distToCenter < MIN_DISTANCE) {
                            const scale = MIN_DISTANCE / distToCenter;
                            newLat = centerPos.lat + (newLat - centerPos.lat) * scale;
                            newLng = centerPos.lng + (newLng - centerPos.lng) * scale;
                        }

                        m.labelMarker.setLatLng([newLat, newLng]);
                        m.leaderLine.setLatLngs([centerPos, [newLat, newLng]]);
                    }
                });

                // ç¹¼çºŒå‹•ç•«
                animationFrame = requestAnimationFrame(startRepulsionAnimation);
            }
        }

        // å‰µå»ºæ¨™è¨˜
        function createMarker(lat, lng, text, isFirst) {
            // ç¢ºä¿åº§æ¨™æ˜¯æ•¸å­—é¡å‹ï¼Œé¿å…å­—ä¸²ä¸²æ¥å•é¡Œ
            lat = parseFloat(lat);
            lng = parseFloat(lng);

            const bgColor = isFirst ? marker1Color : marker2Color;
            const textColor = 'white';
            let markerIcon;

            switch(currentMarkerStyle) {
                case 'text':
                    // æ–‡å­—æ¨™ç±¤æ¨£å¼
                    const textPadding = Math.max(8, markerTextSize * 0.5);
                    const textHeight = Math.max(35, markerTextSize * 2.2);
                    markerIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="
                            background: linear-gradient(135deg, ${bgColor} 0%, ${bgColor}dd 100%);
                            color: ${textColor};
                            border-radius: 10px;
                            padding: ${textPadding}px 12px;
                            text-align: center;
                            font-size: ${markerTextSize}px;
                            font-weight: bold;
                            white-space: nowrap;
                            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                            border: 2px solid white;
                        ">${text}</div>`,
                        iconSize: [150, textHeight],
                        iconAnchor: [75, textHeight / 2]
                    });
                    break;

                case 'pin':
                    // æ¨™æº– Markerï¼ˆä½¿ç”¨å½©è‰² Marker åœ–ç‰‡ï¼‰
                    const pinColor = bgColor.replace('#', '');
                    markerIcon = L.icon({
                        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${getColorName(bgColor)}.png`,
                        shadowUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    });
                    break;

                case 'pin-text':
                    // Marker + æ–‡å­—ï¼ˆä½¿ç”¨è‡ªè¨‚ SVGï¼‰
                    const labelFontSize = Math.max(10, markerTextSize * 0.7);
                    const labelTopOffset = -15 - (labelFontSize * 1.5);
                    markerIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="position: relative; width: 30px; height: 45px;">
                            <svg width="30" height="45" viewBox="0 0 30 45" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));">
                                <path d="M15,0 C6.716,0 0,6.716 0,15 C0,26.25 15,45 15,45 C15,45 30,26.25 30,15 C30,6.716 23.284,0 15,0 Z"
                                      fill="${bgColor}" stroke="white" stroke-width="2"/>
                                <circle cx="15" cy="15" r="8" fill="white"/>
                            </svg>
                            <div style="
                                position: absolute;
                                top: ${labelTopOffset}px;
                                left: 50%;
                                transform: translateX(-50%);
                                background: ${bgColor};
                                color: white;
                                padding: ${Math.max(4, labelFontSize * 0.3)}px ${Math.max(8, labelFontSize * 0.5)}px;
                                border-radius: 6px;
                                font-size: ${labelFontSize}px;
                                font-weight: bold;
                                white-space: nowrap;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                            ">${text}</div>
                        </div>`,
                        iconSize: [30, 45],
                        iconAnchor: [15, 45]
                    });
                    break;

                case 'dot':
                    // å°åœ“é»
                    markerIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="
                            width: 16px;
                            height: 16px;
                            background: ${bgColor};
                            border-radius: 50%;
                            border: 3px solid white;
                            box-shadow: 0 2px 6px rgba(0,0,0,0.4);
                        "></div>`,
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    });
                    break;

                case 'leader-line': {
                    // å¼•å°ç·šæ¨™ç±¤æ¨£å¼ï¼šå›ºå®šé» + å¯æ‹–æ›³æ–‡å­— + é€£æ¥ç·š
                    const centerPos = L.latLng(lat, lng);

                    // è‡ªå‹•æ‰¾åˆ°ä¸é‡ç–Šçš„åç§»æ–¹å‘
                    const offset = findNonOverlappingOffset(lat, lng);
                    const labelPos = L.latLng(lat + offset.lat, lng + offset.lng);

                    // å‰µå»ºå›ºå®šä¸­å¿ƒé»
                    const dotIcon = L.divIcon({
                        className: 'center-dot',
                        html: `<div style="width:12px;height:12px;background:${bgColor};border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.4);"></div>`,
                        iconSize: [12, 12],
                        iconAnchor: [6, 6]
                    });
                    const centerDot = L.marker(centerPos, { icon: dotIcon, draggable: false, zIndexOffset: -100 });

                    // å‰µå»ºå¯æ‹–æ›³æ–‡å­—æ¨™ç±¤
                    const padding = Math.max(8, markerTextSize * 0.5);
                    const height = Math.max(35, markerTextSize * 2.2);
                    const labelIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background:linear-gradient(135deg,${bgColor} 0%,${bgColor}dd 100%);color:${textColor};border-radius:10px;padding:${padding}px 12px;text-align:center;font-size:${markerTextSize}px;font-weight:bold;white-space:nowrap;box-shadow:0 3px 8px rgba(0,0,0,0.3);border:2px solid white;cursor:move;">${text}</div>`,
                        iconSize: [150, height],
                        iconAnchor: [75, height / 2]
                    });
                    const labelMarker = L.marker(labelPos, { icon: labelIcon, draggable: true, zIndexOffset: 1000 });

                    // å‰µå»ºé€£æ¥ç·šï¼ˆä½¿ç”¨å…¨åŸŸè¨­å®šï¼‰
                    const line = L.polyline([centerPos, labelPos], {
                        color: leaderLineColor,
                        weight: leaderLineWidth,
                        opacity: leaderLineOpacity,
                        dashArray: '5, 8'
                    });

                    // å‰µå»ºç¾¤çµ„
                    const group = L.layerGroup([line, centerDot, labelMarker]);
                    group.centerLatLng = centerPos;
                    group.labelMarker = labelMarker;
                    group.centerDot = centerDot;
                    group.leaderLine = line;

                    // åŠ å…¥åˆ°ç£åŠ›æ’æ–¥é™£åˆ—
                    allLeaderLineMarkers.push(group);

                    // ç›£è½æ‹–æ›³æ›´æ–°é€£æ¥ç·šï¼ˆä¸ä½¿ç”¨ç£åŠ›æ’æ–¥ï¼‰
                    labelMarker.on('drag', function(e) {
                        line.setLatLngs([centerPos, e.target.getLatLng()]);
                    });

                    // æš«æ™‚é—œé–‰æ‹–æ›³æ™‚çš„ç£åŠ›æ’æ–¥æ•ˆæœ
                    // setupDragRepulsion(group);

                    return group;
                }
            }

            const marker = L.marker([lat, lng], {
                icon: markerIcon,
                draggable: true
            });

            // ç‚º pin æ¨£å¼æ·»åŠ  tooltip
            if (currentMarkerStyle === 'pin') {
                marker.bindTooltip(text, {
                    permanent: false,
                    direction: 'top',
                    offset: [0, -40]
                });
            }

            return marker;
        }

        // å–å¾—é¡è‰²åç¨±ï¼ˆç”¨æ–¼ Marker åœ–ç‰‡ï¼‰
        function getColorName(hexColor) {
            const colorMap = {
                '#ef5350': 'red',
                '#42a5f5': 'blue',
                '#66bb6a': 'green',
                '#ffa726': 'orange',
                '#ab47bc': 'violet'
            };
            return colorMap[hexColor] || 'blue';
        }

        // ==================== åœ°åœ–æ§åˆ¶ ====================
        function toggleMarkers() {
            if (map.hasLayer(firstMarkerGroup) && map.hasLayer(otherMarkerGroup)) {
                map.removeLayer(firstMarkerGroup);
                map.removeLayer(otherMarkerGroup);
            } else {
                map.addLayer(firstMarkerGroup);
                map.addLayer(otherMarkerGroup);
            }
        }

        function toggleShapes() {
            if (map.hasLayer(firstShapeGroup) && map.hasLayer(otherShapeGroup)) {
                map.removeLayer(firstShapeGroup);
                map.removeLayer(otherShapeGroup);
            } else {
                map.addLayer(firstShapeGroup);
                map.addLayer(otherShapeGroup);
            }
        }

        function toggleFirstMarker() {
            if (map.hasLayer(firstMarkerGroup)) {
                map.removeLayer(firstMarkerGroup);
                map.removeLayer(firstShapeGroup);
            } else {
                map.addLayer(firstMarkerGroup);
                map.addLayer(firstShapeGroup);
            }
        }

        function toggleResults() {
            const container = document.getElementById('resultsContainer');
            const icon = document.getElementById('toggleIcon');

            if (container.style.display === 'none') {
                container.style.display = 'block';
                icon.classList.remove('collapsed');
            } else {
                container.style.display = 'none';
                icon.classList.add('collapsed');
            }
        }

        // ==================== è¼”åŠ©å‡½æ•¸ ====================
        function fillRandomExample() {
            const randomIndex = Math.floor(Math.random() * sampleSets.length);
            document.getElementById('landInput').value = sampleSets[randomIndex];
        }

        function showLoading(show) {
            const queryBtn = document.getElementById('queryBtn');
            if (show) {
                queryBtn.disabled = true;
                queryBtn.innerHTML = '<div class="spinner"></div><span>æŸ¥è©¢ä¸­...</span>';
            } else {
                queryBtn.disabled = false;
                queryBtn.innerHTML = '<span>ğŸ” æŸ¥è©¢ä¸¦é¡¯ç¤ºåœ°åœ–</span>';
            }
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
        }

        function clearError() {
            document.getElementById('errorContainer').innerHTML = '';
        }

        // ==================== åœ°åœ–æˆªåœ–åŠŸèƒ½ ====================
        async function takeMapScreenshot() {
            try {
                // å–å¾—éœ€è¦éš±è—çš„å…ƒç´ 
                const mapControls = document.querySelector('.map-controls');
                const textSizeControl = document.querySelector('.text-size-control');
                const markerSettingsBtn = document.querySelector('.marker-settings-btn');
                const markerSettingsPanel = document.querySelector('.marker-settings-panel');
                const mapContainer = document.querySelector('.map-container');

                // éš±è—æ§åˆ¶å…ƒç´ 
                const elementsToHide = [mapControls, textSizeControl, markerSettingsBtn, markerSettingsPanel];
                elementsToHide.forEach(el => {
                    if (el) el.style.display = 'none';
                });

                // ç­‰å¾…ä¸€å°æ®µæ™‚é–“ç¢ºä¿ DOM æ›´æ–°
                await new Promise(resolve => setTimeout(resolve, 200));

                // ä½¿ç”¨ dom-to-image-more æˆªåœ–ï¼ˆå° Leaflet åœ°åœ–æ”¯æ´æ›´å¥½ï¼‰
                const dataUrl = await domtoimage.toPng(mapContainer, {
                    quality: 1.0,
                    bgcolor: '#ffffff',
                    width: mapContainer.offsetWidth,
                    height: mapContainer.offsetHeight,
                    style: {
                        transform: 'scale(1)',
                        transformOrigin: 'top left'
                    }
                });

                // ç”Ÿæˆæª”æ¡ˆåç¨±
                let filename = 'åœ°åœ–æˆªåœ–';
                if (currentLandData) {
                    // æ ¼å¼ï¼šç¸£å¸‚_åœ°æ®µ_æ—¥æœŸ_æ™‚é–“.png
                    // ä¾‹å¦‚ï¼šè‡ºåŒ—å¸‚_ä¿¡ç¾©æ®µä¸‰å°æ®µ_1117_1530.png
                    const now = new Date();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const hour = String(now.getHours()).padStart(2, '0');
                    const minute = String(now.getMinutes()).padStart(2, '0');
                    const dateStr = `${month}${day}`;
                    const timeStr = `${hour}${minute}`;

                    filename = `${currentLandData.city}_${currentLandData.section}_${dateStr}_${timeStr}`;
                }

                // ä¸‹è¼‰åœ–ç‰‡
                const link = document.createElement('a');
                link.download = `${filename}.png`;
                link.href = dataUrl;
                link.click();

                // é¡¯ç¤ºå›æ§åˆ¶å…ƒç´ 
                elementsToHide.forEach(el => {
                    if (el) el.style.display = '';
                });

            } catch (error) {
                console.error('æˆªåœ–å¤±æ•—:', error);
                alert('æˆªåœ–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚éŒ¯èª¤ï¼š' + error.message);

                // ç¢ºä¿æ§åˆ¶å…ƒç´ é¡¯ç¤ºå›ä¾†
                const elementsToShow = [
                    document.querySelector('.map-controls'),
                    document.querySelector('.text-size-control'),
                    document.querySelector('.marker-settings-btn'),
                    document.querySelector('.marker-settings-panel')
                ];
                elementsToShow.forEach(el => {
                    if (el) el.style.display = '';
                });
            }
        }
    </script>
</body>
</html>
