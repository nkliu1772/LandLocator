# Changelog

## v3.0.0 - Major Update: 智能碰撞偵測與進階功能 (2025-11-17)

### 🌟 **Major Features**

#### 🧠 **智能標籤碰撞偵測系統**
- **8 方向自動選擇算法**
  - 自動偵測標籤是否重疊
  - 依序嘗試：右上、右下、左上、左下、右、左、上、下
  - 選擇第一個不重疊的方向放置標籤
  - 避免標記文字擠在一起，提升可讀性

- **動態邊界框計算**
  - 根據文字大小動態計算標籤範圍
  - 精確的碰撞偵測，確保標籤不重疊
  - 支援不同文字大小的自適應調整

#### 📸 **地圖截圖功能**
- **一鍵匯出純地圖**
  - 使用 `dom-to-image-more` 庫（對 Leaflet 支援更好）
  - 自動隱藏所有控制按鈕（標記、框線、文字大小控制等）
  - 截圖品質提升（scale: 2）
  - 修正標記位置錯誤問題（改用 dom-to-image-more 取代 html2canvas）

- **智能檔案命名**
  - 格式：`縣市_地段_月日_時分.png`
  - 範例：`臺北市_信義段三小段_1117_1530.png`
  - 一眼就能識別截圖內容和時間
  - 避免過長的時間戳記（移除年份、秒數、ISO 8601 的 T 符號）

#### 🎯 **側邊欄摺疊功能**
- **優雅的摺疊動畫**
  - 點擊右邊圓形按鈕（‹/›）可摺疊/展開
  - 平滑的 CSS 過渡動畫（0.3s ease）
  - 摺疊後寬度僅 50px，最大化地圖顯示區域
  - 方便截圖時隱藏查詢區

### 🎨 **引導線優化**
- **預設參數調整**
  - 線條粗細：2px → **4px**（更清晰）
  - 線條顏色：灰色 #666 → **深灰 #333**（更明顯）
  - 透明度：70% → **20%**（線條更清楚）
  - 預設樣式：文字標籤 → **引導線標籤**

### 🐛 **Bug Fixes**
- **修正座標字串串接問題**
  - 問題：`toFixed(6)` 返回字串，與數字相加會變成字串串接
  - 錯誤範例：`"25.127645" + 0.0008` = `"25.1276450.0008"` ❌
  - 修正：保持數字類型進行計算，僅在顯示時轉字串
  - 避免出現 `Invalid LatLng object` 錯誤

- **改進 updateAllMarkers 座標獲取**
  - LayerGroup 類型沒有 `getLatLng()` 方法
  - 增加類型檢查和容錯處理
  - 確保座標獲取正確

### 🔬 **實驗性功能（預設關閉）**
- **磁力排斥演算法**
  - 實作完整的力導向算法（Force-Directed Algorithm）
  - 標籤之間有排斥力（距離越近，力越大）
  - 拖曳時即時推開其他標籤
  - 目前參數需要調整，暫時關閉
  - 程式碼保留在檔案中，未來可啟用

### 🛠️ **Technical Details**
- 新增 `labelBounds` 陣列儲存標籤邊界框
- 新增 `allLeaderLineMarkers` 陣列管理引導線標籤
- 新增 `findNonOverlappingOffset()` 函數實現碰撞偵測
- 新增 `calculateLabelBounds()` 計算標籤範圍
- 新增 `isOverlapping()` 檢查兩矩形是否重疊
- 新增 `takeMapScreenshot()` 實現截圖功能
- 新增 `toggleSidebar()` 實現側邊欄摺疊
- 修正座標類型轉換邏輯
- 使用 `dom-to-image-more` 取代 `html2canvas`

---

## v2.1.0 - Feature: 引導線標籤樣式 (2025-11-17)

### ✨ **New Features**
- **🔗 引導線標籤標記樣式**
  - 新增第五種標記樣式「引導線標籤」，完美解決標記重疊遮擋問題
  - **固定中心點**：在地號實際位置顯示小圓點標記
  - **可拖曳文字標籤**：文字方塊可自由拖動到任意位置
  - **動態連接線**：虛線連接中心點與文字標籤，拖動時即時更新
  - **智慧偏移設計**：文字標籤預設偏移至右上方約 80 公尺，避免擋住中心點

- **🎨 引導線自訂設定**
  - **線條粗細調整**：1-5px 可調，預設 2px
  - **線條顏色選擇**：5 種顏色可選（深灰/灰/淺灰/紅/藍），預設灰色
  - **透明度控制**：0-70% 透明度可調，預設 70% 透明
  - 所有設定整合在標記設定面板中

### 🎯 **使用場景**
- 當多個地號位置相近時，可拖動文字標籤避免重疊
- 截圖時可調整標籤位置，避免遮擋重要設施或地標
- 連接線確保始終能清楚看出每個標籤對應的地塊
- 可自訂線條樣式，使引導線在不同背景下都清晰可見

### 🛠️ **技術改進**
- 使用 Leaflet LayerGroup 組合三個元素（中心點、連接線、文字標籤）
- 使用 block scope 避免變數衝突
- 監聽 drag 事件動態更新 polyline 座標
- 修改 updateAllMarkers 函數以支援 LayerGroup 類型標記
- 透明度轉換邏輯：數值越高線條越透明（opacity = 1 - transparency/100）

---

## v2.0.0 - Modern UI Redesign (2025-11-04)

### ✨ **New Features**
- **全新現代化介面設計**
  - 採用 Bootstrap 5.3.2 響應式框架
  - 左右分欄布局（查詢區 + 地圖區）
  - 精緻的漸層配色與陰影效果

- **5 種標記樣式選擇**
  - 📝 文字標籤
  - 📍 標準 Marker
  - 🏷️ Marker + 文字
  - ⚫ 小圓點
  - 🔗 引導線標籤（v2.1.0 新增）

- **文字大小控制**
  - 滑桿調整文字大小（10-24px）
  - 快速預設按鈕（小/中/大/特大）

- **改進的使用者體驗**
  - 摺疊式結果表格
  - 優化的說明彈窗
  - 更直覺的控制面板

---

## v1.0.0 - Initial Release
### 🛠 Feature: 基本地圖標示功能
- **支援地號轉經緯度查詢**
  - 透過 `Leaflet.js` 顯示地圖
  - 允許輸入多筆地號並顯示對應位置
- **基本標記 (Marker) 功能**
  - 標示「勘估標的」與「比較標的」
  - 可自訂標記顏色（紅色 & 藍色）

---

## v1.1.1 - Feature: 自訂標記設定面板 & 可拖曳標記 (2025-02-02)
### ✨ **New Features**
- **Customizable Marker Appearance**
  - 使用者可**編輯標記文字**（可輸入數字或「比較標的1,2,3」）。
  - 可選擇標記的**背景顏色**（紅、藍、綠、橘、黃）。
  - **新增標記類型**：
    - 預設標記（Leaflet 內建 Marker）
    - 自訂標記（可更改文字樣式）
  - **標記可拖曳移動**，支援使用者手動調整標記位置。

- **New UI Enhancements**
  - **浮動設定面板**：可在地圖上調整標記顏色、標記類型。
  - **新增顯示/隱藏按鈕**：可以控制標記與框線的顯示狀態。

- **Improvement: Map Visibility**
  - 調整地圖高度，使其符合螢幕大小 (`calc(100vh - 100px)`)。
  - 優化按鈕間距，讓 UI 更整齊美觀。

---

## v1.1.2 - Fix: 地號輸入格式 & API 查詢錯誤修正 (2025-02-02)
### 🛠 **Bug Fixes**
#### ✅ Fix: 地號輸入格式
- 允許使用者輸入 `地號`，系統自動轉換為 `號`，確保 API 正確識別。
- **Updated `formatLandInput()` function**，避免誤刪除地號前面的地段名稱

---

## v1.1.3 - Fix: 地名標準化 & 地號格式修正 (2025-02-04)
### 🛠 Fixes
- **修正 API 無法辨識台灣地名的問題**
  - 自動將輸入的 `台北`、`台中`、`台南`、`台東` **轉換為** `臺北`、`臺中`、`臺南`、`臺東`，確保 API 可以正確識別。


## v1.1.4 - Feature: 隨機範例地號 (2025-02-05)

### ✨ **New Features**
- **隨機範例地址功能**  
  - 新增「填入範例」按鈕，可隨機帶入三～四組預設地號範例，方便快速測試。